# 分布式基础

- 看了一半MIT 6.824感觉还是先看看中文的博客和面经吧
- 主要参考自：https://javaguide.cn/distributed-system/theorem&algorithm&protocol/cap&base-theorem.html#_1-%E8%83%8C%E6%99%AF

# 1. CAP理论(Brewer's theorem)

- CAP理论由来：
  - CAP 理论/定理起源于 2000年，由加州大学伯克利分校的Eric Brewer教授在分布式计算原理研讨会（PODC）上提出，因此 CAP定理又被称作 **布鲁尔定理（Brewer’s theorem）**。2年后，麻省理工学院的Seth Gilbert和Nancy Lynch 发表了布鲁尔猜想的证明，CAP理论正式成为分布式领域的定理。
- CAP理论解释？没有明确的定义
  - 一般是：对于一个分布式系统来说，当设计读写操作时，只能同时满足三个中的两个
  - Consistency：一致性：所有节点都可以访问到同一份最新的数据副本
  - Availability：非故障的节点在合理的时间内可以返回合理的响应
  - Partition tolerance：分布式系统出现网络分区的时候，仍然能够对外提供服务
    - 网络分区：在分布式系统中，多个节点之前的网络本来是连通的，但是因为某些故障导致节点之间不连通了，整个网络就分成了几块区域，就称为网络分区
- 3选2？
  - 当发生网络分区时，强一致性C和可用性A只能2选一！
  - 如果不会发生网络分区，也就是不需要保证P的时候，C和A能够同时保证！
  - ZooKeeper、HBase：CP架构
  - Cassandra、Eureka：AP架构
  - Nacos：可以CP和AP架构
- 为什么不可能选择CA架构？
  - 举例：如果系统出现了分区，系统中的某个节点在进行写操作
  - 为了保证C，必须禁止其他节点的读写操作，这就和A发生了冲突
  - 为了保证A，其他节点正常的读写操作的话，就和C发生了冲突
- 如何选择CP？AP？
  - 具体业务场景：对于需要确保强一致性的场景：银行，一般会选择CP

# 2. CAP实际应用-注册中心

- 什么是注册中心？注册中心有什么用？
  - ![image-20220313154755187](1_%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80.assets/image-20220313154755187.png)
  - 注册中心负责服务地址的注册和查找，相当于目录服务
  - 服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小
- ZooKeeper保证的是CP：任何时刻对ZooKeeper的读请求都能够得到一致性的结果，但是ZooKeeper不能保证每次请求的可用性。
  - 比如在Leader选举过程中或者半数以上的机器不可用时服务就是不可用的
- Eureka保证的是AP：在设计之初就是为了优先保证A。
  - 在Eureka中不存在什么Leader节点，每个节点都是一样的、平等的。因此即使大部分节点挂掉也不会影响正常服务，只要有一个节点是可用的就行了，只不过数据可能不是最新的
- Nacos即支持CP也支持AP

# 3. BASE理论

- 什么是BASE理论？
  - BASE 理论起源于 2008 年， 由eBay的架构师Dan Pritchett在ACM上发表
- BASE理论简单理解：（可能有误，待续）
  - Basically Available、Soft-state、Eventually Consistent
  - BASE理论是对CAP中的一致性C和可用性A权衡，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的，大大降低了我们对系统的要求
  - 可以说BASE理论本质是对CAP中的AP的延伸和补充：
    - AP只是在系统发生分区的时候放弃一致性，而不是永远放弃一执性，在分区故障恢复后，系统应该达到最终一致性，这就是BASE理论延伸的地方
- BASE三要素？
  - Basically Available：
    - 基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性，但是不等价于系统不可用
    - 损失部分可用性？
      - 响应时间上的损失：
        - 正常情况下，处理用户请求需要 0.5s 返回结果，但是由于系统出现故障，处理用户请求的时间变为 3 s。
      - 系统功能上的损失：
        - 正常情况下，用户可以使用系统的全部功能，但是由于系统访问量突然剧增，系统的部分非核心功能无法使用。
  - Soft-state：
    - 软状态指允许系统中的数据存在中间形态（CAP中的数据不一致），并认为该中间形态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时
  - Eventually Consistent：
    - 最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。所以：最终一致性的本质需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性
- 分布式一致性的三种级别？
  - 强一致性：系统写入了什么，读出来就是什么
  - 弱一致性：不一定可以读取到最新写入的值，也不保证多少时间后读取到的数据是最新的，只是会尽量保证某个时刻能够达到数据一致的状态
  - 最终一致性：弱一致性的升级版，系统会保证在一定时间内达到数据一致的状态
- 如何实现最终一致性？
  - 读时修复：在读取数据时，检测数据的不一致进行修复。
    - 比如Cassandra的Read Repair实现，具体来说，在向Cassandra系统查询数据的时候，如果检测到不同节点的副本数据不一致，系统就自动修复数据
  - 写时修复：在写入数据，检测数据的不一致时进行修复。性能消耗较低
    - 比如Cassandra的Hinted Handoff实现，具体来说，Cassandra集群的节点之间远程写数据的时候，如果写失败就将数据缓存下来，然后定时重传，修复数据的不一致
  - 异步修复：最常用的方式，通过定时对账检测副本数据的一致性并修复。
- 小总结：
  - 数据库的事务完整性理论：ACID
  - 分布式系统设计理论：CAP
  - CAP理论的AP延伸：BASE

# 4. Paxos算法

- 什么时Paxos算法？未完待续
  - Paxos 算法诞生于 1990 年，这是一种解决分布式系统一致性的经典算法 。但是，由于 Paxos 算法在国际上被公认的非常难以理解和实现，因此不断有人尝试简化这一算法。到了2013 年才诞生了一个比 Paxos 算法更易理解和实现的分布式一致性算法—Raft 算法

# 5. Raft算法

- 为什么要有Raft算法？
  - 如今的数据中心和应用程序在高度动态的环境中运行，为了应对高度动态的环境，通常使用额外的服务器进行横向扩展，并且根据需求进行扩展和收缩。但是服务器和网络故障又很常见
  - 对系统来说：系统必须在正常操作期间处理服务器的上下线，必须对故障等变故做出反应并且在一定时间内自动适应
  - 对客户端来说：明显的中断是不可接受的
  - 如何解决？分布式共识、相应的算法
- 拜占庭将军问题？
  - 简化版：多个拜占庭将军，没有叛徒，信使的信息可靠，但是有可能被暗杀，将军们如何达成是否要进攻的一致性决定？
  - 解决方案的核心思想：
    - 先在所有的将军中选择出一个大将军，用来做所有的决定
    - 举例：3位将军ABC，每个将军都有一个随机时间的倒计时器
      - 假设A的计时器先结束，计时器一结束，就可以把自己当成大将军的候选人，然后派信使传递选举投票信息给将军B和C（他们的计时器没有结束，并且没有把选举票投给其他人），就会把票投给A，信使回到将军A时，A就知道自己收到了足够的票数，成为了大将军。
      - 是否需要进攻就由大将军A决定，然后再派去信使通知另外两个大将军，自己已经成为了大将军，如果一段时间还没有收到B和C的回复（可能被暗杀），就重新派一个信使，直到收到回复
- 共识算法？
  - 共识是可容错系统中的一个基本问题：即使面对故障，服务器也可以在共享状态上达成一致
  - 共识算法：允许一组节点像一个整体一样一起工作，即使其中的一些节点出现故障也能够继续工作下去
  - 主要思想：复制状态机的性质：一组Server的状态机计算系统状态的副本，即使有一部分的Server宕机了仍然可以继续允许
  - ![image-20220314142931345](1_%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80.assets/image-20220314142931345.png)
  - 如何实现复制状态机？
    - 一般通过使用复制日志来实现复制状态机。每个Server存储着一份包括命令序列的日志文件，状态机会按照顺序执行这些命令。因为每个日志包含相同的命令，并且顺序也相同，所以每个状态机处理相同的命令序列。由于状态机是确定性的，所以处理相同的状态，得到相同的输出。
  - 共识算法的核心？
    - 主要是保持复制日志的一致性。服务器上的共识模块从客户端接受命令并将它们添加到日志中，它与其他服务器上的共识模块通信，以确保即使某些服务器发生故障。每个日志最终包含相同时顺序的请求。
    - 一旦命令被正确复制，就被称为已提交。每个服务器的状体机按照日志处理已提交的命令，并将输出返回给客户端，因此这些服务器形成了一个单一的、高度可靠的状态机
  - 实际系统中的共识算法的特性：
    - 安全：确保在非拜占庭条件下的安全性，包括网络延迟、分区、包丢失、复制和重新排序
    - 高可用：只要大多数服务器上可操作的，并且可以相互通信，也可以与客户端进行通信，那么这些服务器就可以看作完全功能可用的。
      - 因此，一个典型的由五台服务器组成的集群可以容忍任何两台服务器端故障。假设服务器因停止而发生故障；它们稍后可能会从稳定存储上的状态中恢复并重新加入集群。
    - 一致性不依赖时序：错误的时钟和极端的消息延迟，在最坏的情况下也只会造成可用性问题，而不会产生一致性问题
    - 在集群中大多数服务器响应，命令就可以完成，不会被少数运行缓慢的服务器来影响整体系统性能。